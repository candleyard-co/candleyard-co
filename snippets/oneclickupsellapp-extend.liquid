{% assign api = shop.metafields.zipifyoneclickupsell | size %}{%- unless api == 0 -%}
<script>((o,c,u)=>{o[c]=o[c]||{},o[u]=o[u]||{},o[c].OCU=o[c].OCU||{api:o[u]}})(window,'Zipify','OCUApi');</script>
<script>
    Zipify.OCU.api.callbackBeforeRedirect = (dispatcher, event) => {
        return new Promise((resolve) => {
            try {
                if (dispatcher.destination === 'checkout') return resolve({});
                
            const { response, type } = event.detail;
            if (!(type === 'Upgrade' && response.accepted)) return resolve({});

            dispatcher._upsellAppInstance().hide();
            dispatcher.target.disabled = false;
            setTimeout(() => Zipify.OCU.api.store.set('submitted', false));
            
            const cartDrawer = document.querySelector('cart-drawer-component');
            cartDrawer.open()
        } catch (e) {
            resolve({});
        }
    });
};
</script>
{%- endunless -%}