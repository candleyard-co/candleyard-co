{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.
  The product object is null or when placeholders are rendered.

  @param {object} product - The product object
{%- enddoc -%}

{% style %}
  {% if request.visual_preview_mode %}
    product-card-link {
      width: 100%;
      min-width: 250px;
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign has_quick_add = false
  if settings.quick_add and product.available
    assign has_quick_add = true
  endif

  assign has_mobile_quick_add = true
  if has_quick_add and settings.mobile_quick_add
    assign has_mobile_quick_add = true
  endif

  assign product_card_id = 'product-card-link-' | append: 'upsell' | append: '-' | append: product.id
  assign product_card_gap_value = 12

  # Logic to determine which variant URL to use (matching swatch selection logic)
  assign variant_to_link = product.selected_or_first_available_variant

  if settings.transition_to_main_product
    assign featured_image = variant_to_link.featured_image
    if featured_image == blank
      assign featured_image = product.featured_media.preview_image
    endif

    if featured_image != blank
      assign featured_media_url = featured_image | image_url: width: 500
    endif
  endif

  assign onboarding = false
  if product.id == empty or product == blank
    assign onboarding = true
  endif
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
    {% if onboarding %}
      data-placeholder="true"
    {% endif %}
  >
{%- endif -%}
<product-card
  class="product-card upsell-card"
  data-product-id="{{ product.id }}"
  id="product-card-upsell-{{ product.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
  {% if onboarding %}
    data-placeholder="true"
  {% endif %}
>
  <a
    id="{{ product_card_id | md5 }}"
    {% unless onboarding %}
      href="{{ variant_to_link.url }}"
    {% endunless %}
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
    "
    style="
      {% render 'gap-style', value: product_card_gap_value, name: 'product-card-gap' %}
      --quick-add-display: flex;
      --quick-add-mobile-display: flex;
      --quick-add-mobile-opacity: 1;
    "
  >
    <div class="upsell-content-column flex">
        <div>
            <div class="upsell-image-wrapper">
                {% if product.featured_media != blank %}
                    {% assign media = product.selected_or_first_available_variant.featured_media | default: product.featured_media %}

                    {% assign image_height = media.height %}
                    {% assign image_height_2x = image_height | times: 2 %}
                    {% assign image_height_3x = image_height | times: 3 %}

                    {% capture image_srcset %}
                        {{ media.preview_image | image_url: height: image_height }} 1x,
                        {{ media.preview_image | image_url: height: image_height_2x }} 2x,
                        {{ media.preview_image | image_url: height: image_height_3x }} 3x
                    {% endcapture %}

                    {{ media.preview_image
                        | image_url: height: image_height
                        | image_tag:
                        class: class,
                        srcset: image_srcset
                    }}
                {% endif %}
                <div class="upsell-quick-wrapper">
                    {% render 'quick-add', product: product, section_id: 'cart-upsell' %}
                </div>
            </div>
        </div>
        <div>
            <span class="upsell-title">{{ product.title }}</span>
            {% render 'price', product_resource: product, show_sale_price_first: true %}
        </div>
    </div>
  </div>
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}

{% stylesheet %}
  product-card-link,
  :not(product-card-link) product-card {
    width: 100%;
  }

  .product-card__placeholder-image svg {
    height: 100%;
  }

  @media screen and (max-width: 749px) {
    .product-card slideshow-arrows .slideshow-control {
      display: none;
    }
  }

  /* Hide "Add" button when "Choose" button is shown */
  [data-quick-add-button='choose'] add-to-cart-component {
    display: none;
  }

  /* Hide "Choose" button when "Add" button is shown */
  [data-quick-add-button='add'] .quick-add__button--choose {
    display: none;
  }

    .upsell-content-column {
        flex-direction: column;
    }

    .upsell-content-column > div {
        width: 100%;
    }

    .upsell-image-wrapper {
        position: relative;
    }

    .upsell-card .product-card__content {
        height: auto;
    }

    .upsell-card .upsell-title {
        font-family: var(--font-heading--family);
        font-style: var(--font-heading--style);
        font-weight: var(--font-heading--weight);
        font-size: var(--font-size--sm);
        line-height: 1.2em;
        display: block;
    }

    .upsell-card .product-card__content img {
        display: block;
        max-width: 100%;
        width: 100%;
        height: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 12px;
    }
/* 
    .upsell-quick-wrapper {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: fit-content;
    } */

    [ref="priceContainer"] {
        font-size: var(--cart-font-size--sm);
        margin-top: var(--margin-3xs);
    }

    .upsell-card add-to-cart-component .quick-add__button {
        display: flex !important;
        opacity: 1 !important;
        bottom: 0.4rem !important;
        right: 0.4rem !important;
        font-size: var(--font-size--xs);
    }
{% endstylesheet %}
